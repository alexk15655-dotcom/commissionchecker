# Структура расчёта комиссий

## Содержание
1. [Обзор системы](#обзор-системы)
2. [Источники данных](#источники-данных)
3. [Типы менеджеров](#типы-менеджеров)
4. [Правила комиссий](#правила-комиссий)
5. [Milestones (Бонусы)](#milestones-бонусы)
6. [Алгоритм расчёта](#алгоритм-расчёта)
7. [Примеры расчётов](#примеры-расчётов)

---

## Обзор системы

Система расчёта комиссий предназначена для автоматического начисления выплат менеджерам на основе предоплат финансовых групп (ФГ), которые они привели или курируют.

### Основные сущности:
- **ФГ (Финансовая группа)** — клиент/агент с уникальным номером
- **Предоплаты** — пополнения баланса ФГ
- **Менеджеры** — Recruiters и Account Managers, которым начисляются комиссии
- **Правила комиссий** — условия начисления комиссий
- **Milestones** — бонусы за достижение определённых показателей

---

## Источники данных

### 1. Данные по ФГ (`fgData`)

**Файл:** CSV с данными по финансовым группам

**Основные поля:**
- `ФГ` — название финансовой группы (например: "Иван Петров Новая ФГ")
- `Номер ФГ` — уникальный идентификатор ФГ
- `Начало работы` — дата создания ФГ (формат: DD.MM.YYYY)
- `Реф` — реферал/источник
- `source` — источник клиента (Recruiter, Account, Проект, Органика, Акция)
- `manager` — привязанный менеджер (объект с `id` и `name`)
- `agent` — имя агента (извлекается из названия ФГ)

**Генерация недостающих данных:**
- Если дата начала работы отсутствует, генерируется случайная дата за последние 12 месяцев
- Имя агента извлекается из первых двух слов названия ФГ

### 2. Данные по предоплатам (`prepaymentsData`)

**Файл:** CSV с данными по пополнениям

**Основные поля:**
- `Номер фин. группы` — ссылка на ФГ по номеру
- `Фин. группа` — название ФГ
- `Период` — дата предоплаты (формат: DD.MM.YYYY или "нояб. 25 г.")
- `Пополнения $` / `Пополнения` — сумма предоплаты

**Генерация недостающих данных:**
- Для ФГ без предоплат создаётся первая предоплата:
  - Дата: 0-30 дней после даты начала работы
  - Сумма: случайная от $100 до $5000

---

## Типы менеджеров

### Recruiter
- Привлекает новых агентов
- Комиссия за первые предоплаты новых ФГ
- Обычно получает бонусы за новых агентов

### Account Manager
- Курирует существующих клиентов
- Комиссия за все предоплаты или за поддержку агентов
- Может получать бонусы за объём

---

## Правила комиссий

Правила определяют условия начисления комиссий менеджерам.

### Структура правила

```javascript
{
  id: 1,
  name: "Q4 2024 Enhanced Commission",
  managerType: "recruiter", // или "account"
  managerIds: [1, 2, 3], // ID менеджеров, к которым применяется

  // ШАГ 1: Тип начисления
  paymentType: "percentage", // или "fixed"
  paymentValue: 5, // 5% или $5 (в зависимости от paymentType)

  // ШАГ 2: Условие применения
  applyTo: "all", // или "firstPrepayment", "earlyFg", "groupWithThreshold"

  // ШАГ 3: Ограничения
  constraints: {
    maxPerPayment: 500, // Максимум за агента
    minGroupThreshold: 1000, // Минимальный порог группы
    periodOnly: false, // Только в период отчёта
    newAgentsOnly: false, // Только новые агенты
    newAgentsMonths: 3 // Не старше 3 месяцев
  },
  constraintsLogic: "AND" // или "OR"
}
```

### ШАГ 1: Тип начисления

#### `percentage` — Процент от суммы
```
Комиссия = Сумма предоплат × (paymentValue / 100)
```
**Пример:** 5% от $1000 = $50

#### `fixed` — Фиксированная сумма
```
Комиссия = paymentValue
```
**Пример:** $100 за каждого агента

---

### ШАГ 2: Условие применения

Определяет, к каким предоплатам применяется правило.

#### `all` — За все предоплаты
- Комиссия начисляется за каждую предоплату ФГ с менеджером
- Считаются все предоплаты в периоде отчёта (если задан)

**Пример:**
```
ФГ №123: $500 (янв), $300 (фев), $200 (мар)
Правило: 5% за все
Комиссия = ($500 + $300 + $200) × 5% = $50
```

#### `firstPrepayment` — За первую предоплату агента
- Начисляется только за самую первую предоплату каждого агента
- Игнорируются последующие предоплаты

**Пример:**
```
Агент "Иван Петров":
  ФГ №123: первая предоплата $500 (15.01.2024)
  ФГ №124: первая предоплата $300 (20.02.2024)
Правило: $100 за первую предоплату агента
Комиссия = $100 (только за самую раннюю)
```

**Логика определения первой предоплаты:**
1. Собираются все предоплаты агента по всем его ФГ
2. Выбирается самая ранняя по дате
3. Комиссия начисляется только за эту предоплату

#### `earlyFg` — За раннюю ФГ группы
- Комиссия за предоплаты самой ранней ФГ с менеджером
- Определяется по дате начала работы ФГ

**Пример:**
```
Агент "Иван Петров":
  ФГ №123 (начало: 15.01.2024): предоплаты $500, $300
  ФГ №124 (начало: 20.02.2024): предоплаты $400
Правило: 5% за раннюю ФГ
Комиссия = ($500 + $300) × 5% = $40
```

#### `groupWithThreshold` — За группу при достижении порога
- Комиссия за все ФГ с менеджером
- Начисляется только когда общая сумма достигает порога (см. `minGroupThreshold`)

**Пример:**
```
Менеджер привёл агентов:
  Агент 1: $500
  Агент 2: $400
  Агент 3: $300
Правило: 5% при достижении $1000
Комиссия = ($500 + $400 + $300) × 5% = $60 (порог $1000 достигнут)
```

---

### ШАГ 3: Ограничения

Дополнительные условия, которые фильтруют применение правила.

#### `maxPerPayment` — Максимальная выплата за агента
Ограничивает комиссию за одного агента.

```
Комиссия_итоговая = min(Комиссия_рассчитанная, maxPerPayment)
```

**Пример:**
```
Предоплаты агента: $10,000
Правило: 5% с максимумом $500
Расчёт: $10,000 × 5% = $500
Ограничение: min($500, $500) = $500 ✓
```

#### `minGroupThreshold` — Минимальный порог группы
Не начислять комиссию, пока сумма ФГ с менеджером не достигнет порога.

**Пример:**
```
Сумма по агенту: $800
Правило: 5% при пороге $1000
Результат: комиссия НЕ начисляется ($800 < $1000)

Сумма по агенту: $1500
Результат: комиссия начисляется ($1500 ≥ $1000)
```

#### `periodOnly` — Только в период отчёта
Фильтрует по периоду отчёта в зависимости от условия применения:
- Для `firstPrepayment`: первая предоплата должна быть в периоде
- Для остальных: предоплаты должны быть в периоде

**Пример:**
```
Период отчёта: 01.01.2024 - 31.01.2024
Первая предоплата агента: 15.01.2024 ($500)
Правило: $100 за первую предоплату (только в период)
Результат: комиссия начисляется ✓

Первая предоплата агента: 15.12.2023 ($500)
Результат: комиссия НЕ начисляется ✗
```

#### `newAgentsOnly` + `newAgentsMonths` — Только новые агенты
Применяется только к агентам, чья первая ФГ создана не раньше X месяцев назад.

**Пример:**
```
Дата расчёта: 01.03.2024
Правило: только агенты не старше 3 месяцев

Агент 1 (первая ФГ: 15.01.2024):
  01.03.2024 - 15.01.2024 = 1.5 месяца ✓ подходит

Агент 2 (первая ФГ: 15.10.2023):
  01.03.2024 - 15.10.2023 = 4.5 месяца ✗ не подходит
```

#### `constraintsLogic` — Логика комбинирования
- `AND`: все ограничения должны быть выполнены
- `OR`: хотя бы одно ограничение должно быть выполнено

**Пример AND:**
```
Ограничения:
  - minGroupThreshold: $1000
  - newAgentsOnly: 3 месяца

Результат: комиссия начисляется только если:
  сумма ≥ $1000 И агент не старше 3 месяцев
```

**Пример OR:**
```
Ограничения (OR):
  - minGroupThreshold: $1000
  - newAgentsOnly: 3 месяцев

Результат: комиссия начисляется если:
  сумма ≥ $1000 ИЛИ агент не старше 3 месяцев
```

---

## Milestones (Бонусы)

Milestones — это бонусные выплаты за достижение определённых показателей.

### Структура Milestone

```javascript
{
  id: 1,
  name: "Первые $10,000",
  managerGroup: "all", // "all", "recruiters", "accounts", "custom"
  assignedManagers: [1, 2], // для "custom"
  targetAmount: 10000, // целевая сумма

  paymentType: "percentage", // "percentage", "fixed", "percentageWithCap"
  paymentValue: 10, // 10% или $10
  maxPayment: 1000 // для "percentageWithCap"
}
```

### Группы менеджеров

#### `all` — Все менеджеры
Бонус доступен всем менеджерам (Recruiters и Account Managers).

#### `recruiters` — Только Recruiters
Бонус доступен только менеджерам типа Recruiter.

#### `accounts` — Только Account Managers
Бонус доступен только менеджерам типа Account Manager.

#### `custom` — Выбранные вручную
Бонус доступен только менеджерам из списка `assignedManagers`.

### Типы выплат

#### `percentage` — Процент
```
Бонус = Сумма предоплат агента × (paymentValue / 100)
```

**Пример:**
```
Агент достиг $10,000
Milestone: 10% за первые $10,000
Бонус = $10,000 × 10% = $1,000
```

#### `fixed` — Фиксированная сумма
```
Бонус = paymentValue
```

**Пример:**
```
Агент достиг $10,000
Milestone: $500 за первые $10,000
Бонус = $500
```

#### `percentageWithCap` — Процент с ограничением
```
Бонус = min(Сумма × (paymentValue / 100), maxPayment)
```

**Пример:**
```
Агент достиг $15,000
Milestone: 10% за первые $10,000 (макс. $1,000)
Расчёт: $15,000 × 10% = $1,500
Бонус = min($1,500, $1,000) = $1,000
```

### Условие срабатывания

Milestone срабатывает когда:
```
totalPrepayments (агента) ≥ targetAmount
```

Бонус начисляется **за каждого агента**, который достиг целевой суммы.

---

## Алгоритм расчёта

### 1. Подготовка данных

```javascript
// Загружаем данные
fgData = await db.getAll('fgData');
prepaymentsData = await db.getAll('prepaymentsData');

// Группируем ФГ по агентам
agentGroups = {};
fgData.forEach(fg => {
  agent = extractAgentName(fg['ФГ']);
  agentGroups[agent] = [...агенты с похожими именами];
});

// Определяем самую раннюю ФГ для каждого агента
agentEarliestFgDate = {};
```

### 2. Инициализация данных агентов

Для каждого агента создаётся структура:

```javascript
agentData[agent] = {
  fgs: [], // все ФГ агента
  totalPrepayments: 0, // сумма всех предоплат
  prepaymentsInPeriod: 0, // сумма предоплат в периоде
  manager: { id, name }, // привязанный менеджер
  earliestFgDate: Date, // дата первой ФГ
  firstPrepaymentDate: Date, // дата первой предоплаты
  firstPrepaymentAmount: 0, // сумма первой предоплаты
  commissions: {} // начисленные комиссии по правилам
};
```

### 3. Обработка предоплат

Для каждой предоплаты:

```javascript
// 1. Находим ФГ
fg = fgData.find(f => f['Номер ФГ'] == payment['Номер фин. группы']);

// 2. Определяем агента
agent = fg.agent || extractAgentName(fg['ФГ']);

// 3. Парсим сумму
amount = parseFloat(payment['Пополнения $']);

// 4. Парсим дату
paymentDate = parseRussianDate(payment['Период']);

// 5. Проверяем период
isInPeriod = paymentDate >= startDate && paymentDate <= endDate;

// 6. Обновляем данные агента
agentData[agent].totalPrepayments += amount;
if (isInPeriod) {
  agentData[agent].prepaymentsInPeriod += amount;
}

// 7. Фиксируем первую предоплату
if (!firstPrepaymentDate || paymentDate < firstPrepaymentDate) {
  agentData[agent].firstPrepaymentDate = paymentDate;
  agentData[agent].firstPrepaymentAmount = amount;
}

// 8. Сохраняем дату первой предоплаты для ФГ
if (!fgFirstPrepaymentDates[fgNumber] || paymentDate < fgFirstPrepaymentDates[fgNumber]) {
  fgFirstPrepaymentDates[fgNumber] = paymentDate;
}
```

### 4. Применение правил комиссий

Для каждого агента:

```javascript
// 1. Находим применимые правила
applicableRules = rules.filter(r =>
  r.managerIds.includes(managerId)
);

// 2. Добавляем персональные правила менеджера
if (manager.personRules) {
  applicableRules.push(...manager.personRules);
}

// 3. Для каждого правила
applicableRules.forEach(rule => {

  // 3.1. Проверяем ограничения
  if (rule.constraints.newAgentsOnly) {
    monthsAgo = new Date(reportDate);
    monthsAgo.setMonth(reportDate.getMonth() - rule.constraints.newAgentsMonths);
    if (earliestFgDate < monthsAgo) return; // Агент слишком старый
  }

  if (rule.constraints.minGroupThreshold) {
    if (totalPrepayments < rule.constraints.minGroupThreshold) return;
  }

  if (rule.constraints.periodOnly) {
    if (applyTo === 'firstPrepayment') {
      if (firstPrepaymentDate < startDate || firstPrepaymentDate > endDate) return;
    }
  }

  // 3.2. Определяем сумму для расчёта
  if (rule.applyTo === 'all') {
    amountToCalculate = prepaymentsInPeriod || totalPrepayments;
  } else if (rule.applyTo === 'firstPrepayment') {
    if (firstPrepaymentDate >= startDate && firstPrepaymentDate <= endDate) {
      amountToCalculate = firstPrepaymentAmount;
    }
  } else if (rule.applyTo === 'earlyFg') {
    earliestFg = fgs.sort((a,b) => a.startDate - b.startDate)[0];
    amountToCalculate = сумма_предоплат_earliest_fg_в_периоде;
  } else if (rule.applyTo === 'groupWithThreshold') {
    amountToCalculate = prepaymentsInPeriod || totalPrepayments;
  }

  // 3.3. Рассчитываем комиссию
  if (rule.paymentType === 'percentage') {
    commission = (amountToCalculate × rule.paymentValue) / 100;
  } else if (rule.paymentType === 'fixed') {
    commission = rule.paymentValue;
  }

  // 3.4. Применяем кэп
  if (rule.constraints.maxPerPayment) {
    commission = min(commission, rule.constraints.maxPerPayment);
  }

  // 3.5. Добавляем к менеджеру
  commissionData[managerId].commission += commission;
});
```

### 5. Применение Milestones

Для каждого агента:

```javascript
milestones.forEach(milestone => {

  // 1. Проверяем применимость к менеджеру
  isApplicable =
    milestone.managerGroup === 'all' ||
    (milestone.managerGroup === 'recruiters' && managerType === 'recruiter') ||
    (milestone.managerGroup === 'accounts' && managerType === 'account') ||
    (milestone.managerGroup === 'custom' && milestone.assignedManagers.includes(managerId));

  // 2. Проверяем достижение цели
  if (isApplicable && totalPrepayments >= milestone.targetAmount) {

    // 3. Рассчитываем бонус
    if (milestone.paymentType === 'fixed') {
      milestoneBonus = milestone.paymentValue;
    } else if (milestone.paymentType === 'percentage') {
      milestoneBonus = (totalPrepayments × milestone.paymentValue) / 100;
      if (milestone.maxPayment) {
        milestoneBonus = min(milestoneBonus, milestone.maxPayment);
      }
    } else if (milestone.paymentType === 'percentageWithCap') {
      milestoneBonus = (totalPrepayments × milestone.paymentValue) / 100;
      if (milestone.maxPayment) {
        milestoneBonus = min(milestoneBonus, milestone.maxPayment);
      }
    }

    // 4. Добавляем к менеджеру
    commissionData[managerId].milestoneBonus += milestoneBonus;
  }
});
```

### 6. Итоговый расчёт

Для каждого менеджера:

```javascript
commissionData[managerId] = {
  managerId: id,
  managerName: "Имя менеджера",
  managerType: "recruiter" | "account",
  totalPrepayments: сумма_всех_предоплат,
  commission: сумма_комиссий,
  milestoneBonus: сумма_бонусов,
  agentsCount: количество_агентов,
  agents: [список_агентов]
};

// Итого для менеджера
total = commission + milestoneBonus;
```

---

## Примеры расчётов

### Пример 1: Процент за все предоплаты

**Данные:**
- Менеджер: Recruiter #1
- Агент: "Иван Петров"
- ФГ №123:
  - Дата начала: 15.01.2024
  - Предоплаты: $500 (20.01), $300 (15.02), $200 (10.03)
- Период отчёта: 01.01.2024 - 31.03.2024

**Правило:**
```javascript
{
  name: "Стандартная комиссия",
  paymentType: "percentage",
  paymentValue: 5,
  applyTo: "all",
  constraints: {}
}
```

**Расчёт:**
```
Сумма в периоде = $500 + $300 + $200 = $1000
Комиссия = $1000 × 5% = $50
```

**Результат:** Recruiter #1 получает **$50**

---

### Пример 2: Фикс за первую предоплату агента

**Данные:**
- Менеджер: Recruiter #2
- Агент: "Мария Иванова"
- ФГ №124:
  - Дата начала: 01.02.2024
  - Первая предоплата: $800 (05.02.2024)
  - Последующие: $400 (15.03.2024)
- Период отчёта: 01.02.2024 - 31.03.2024

**Правило:**
```javascript
{
  name: "Бонус за нового агента",
  paymentType: "fixed",
  paymentValue: 100,
  applyTo: "firstPrepayment",
  constraints: {
    periodOnly: true
  }
}
```

**Расчёт:**
```
Первая предоплата: 05.02.2024 ($800)
В периоде отчёта: ✓
Комиссия = $100 (фиксированная)
```

**Результат:** Recruiter #2 получает **$100**

---

### Пример 3: Процент с кэпом и порогом

**Данные:**
- Менеджер: Account Manager #1
- Агент: "Сергей Сидоров"
- Общая сумма предоплат: $12,000
- Период отчёта: весь 2024 год

**Правило:**
```javascript
{
  name: "Усиленная комиссия для крупных клиентов",
  paymentType: "percentage",
  paymentValue: 7,
  applyTo: "all",
  constraints: {
    minGroupThreshold: 5000,
    maxPerPayment: 500
  }
}
```

**Расчёт:**
```
Сумма = $12,000
Порог достигнут: $12,000 ≥ $5,000 ✓
Расчёт: $12,000 × 7% = $840
Кэп: min($840, $500) = $500
Комиссия = $500
```

**Результат:** Account Manager #1 получает **$500**

---

### Пример 4: Milestone + Обычная комиссия

**Данные:**
- Менеджер: Recruiter #3
- Агент: "Анна Петрова"
- Общая сумма предоплат: $15,000
- Период отчёта: весь 2024 год

**Правило комиссии:**
```javascript
{
  name: "Стандартная комиссия",
  paymentType: "percentage",
  paymentValue: 5,
  applyTo: "all"
}
```

**Milestone:**
```javascript
{
  name: "Первые $10,000",
  targetAmount: 10000,
  paymentType: "fixed",
  paymentValue: 500,
  managerGroup: "recruiters"
}
```

**Расчёт:**
```
Комиссия = $15,000 × 5% = $750
Milestone = $500 (достигнут порог $10,000)
Итого = $750 + $500 = $1,250
```

**Результат:** Recruiter #3 получает **$1,250**

---

### Пример 5: Только новые агенты

**Данные:**
- Дата расчёта: 01.04.2024
- Менеджер: Recruiter #4
- Агенты:
  - Агент 1 (первая ФГ: 15.02.2024): $3,000
  - Агент 2 (первая ФГ: 15.11.2023): $5,000

**Правило:**
```javascript
{
  name: "Бонус за новых агентов",
  paymentType: "percentage",
  paymentValue: 10,
  applyTo: "all",
  constraints: {
    newAgentsOnly: true,
    newAgentsMonths: 3
  }
}
```

**Расчёт:**
```
Агент 1:
  Дата первой ФГ: 15.02.2024
  Возраст: 01.04.2024 - 15.02.2024 = 1.5 месяца ✓ подходит
  Комиссия = $3,000 × 10% = $300

Агент 2:
  Дата первой ФГ: 15.11.2023
  Возраст: 01.04.2024 - 15.11.2023 = 4.5 месяца ✗ НЕ подходит
  Комиссия = $0

Итого = $300
```

**Результат:** Recruiter #4 получает **$300**

---

## Дополнительная информация

### Парсинг дат

Система поддерживает несколько форматов дат:

1. **DD.MM.YYYY** — `15.01.2024`
2. **DD.MM.YY** — `15.01.24` (автоматически 2024 если < 50, иначе 19XX)
3. **Русский формат** — `нояб. 25 г.` или `нояб. 2025 г.`

### Генерация данных

При нажатии кнопки "Сгенерировать недостающие данные":
- **Даты начала работы:** случайная дата за последние 12 месяцев
- **Первые предоплаты:** 0-30 дней после начала работы, сумма $100-$5000

### Извлечение имени агента

Из названия ФГ берутся **первые два слова**:
```
"Иван Петров Новая ФГ" → "Иван Петров"
"Мария Группа" → "Мария Группа"
```

### Группировка агентов

Агенты с похожими именами (разница до 2 символов по расстоянию Левенштейна) объединяются в одну группу.

---

## Файловая структура

```
commissionchecker/
├── index.html              # Главная страница
├── js/
│   ├── app.js             # Главный контроллер, загрузка данных
│   ├── db.js              # IndexedDB для хранения данных
│   ├── managers.js        # Управление менеджерами
│   ├── rules.js           # Управление правилами комиссий
│   ├── milestones.js      # Управление Milestones
│   ├── fg.js              # Просмотр ФГ
│   └── report.js          # Расчёт и отображение отчёта
└── css/
    └── styles.css         # Стили
```

---

## Изменения в последних версиях

### v6.0 (текущая)
- ✅ Добавлена дата первой предоплаты в отчёт
- ✅ Расширенная структура таблицы отчёта
- ✅ Поддержка формата DD.MM.YYYY для дат предоплат
- ✅ Оптимизация вычисления дат первой предоплаты
- ✅ Кнопка "Сгенерировать недостающие данные"

### Ключевые улучшения:
- Предвычисление дат первой предоплаты для каждой ФГ
- Корректное отображение дат даже если предоплата раньше начала работы
- Генерация отсутствующих данных с реалистичными значениями
