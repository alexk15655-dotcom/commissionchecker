# Система расчета комиссий v3

Vanilla JS MVP для расчета комиссий менеджеров с продвинутой логикой групп агентов.

## Критические обновления v3

### ✅ Пересечение ФГ с предоплатами
- Используются **только ФГ, которые есть в файле предоплат**
- После загрузки предоплат автоматически фильтруются ФГ
- Консоль показывает: "Отфильтровано ФГ: X из Y"

### ✅ Логика групп агентов
**Ключевое правило:** Если хотя бы одна ФГ в группе агента приведена рекрутером/аккаунтом, то:
- Все ФГ этой группы считаются за этим менеджером
- ФГ с другими источниками (Проект/Органика/Акция) в той же группе **НЕ получают комиссию**
- Только ФГ с назначенным менеджером учитываются в расчётах

**Примеры:**
```
Группа "Omar Ali":
├─ ФГ1 (Recruiter: Иванов) → комиссия Иванову
├─ ФГ2 (Проект) → НЕТ комиссии
└─ ФГ3 (Органика) → НЕТ комиссии

Группа "Nora Georgi":
├─ ФГ1 (Проект) → НЕТ комиссии
└─ ФГ2 (Органика) → НЕТ комиссии
```

### ✅ Milestones по группам
- Milestones считаются **по всей сумме группы агента**
- Если агент приведён рекрутером → milestone начисляется этому рекрутеру
- Сумма = все предоплаты всех ФГ агента (включая Проект/Органика/Акция)

**Пример:**
```
Группа "Omar Ali" (всего $5000):
├─ ФГ1 (Recruiter: Иванов) $2000
├─ ФГ2 (Проект) $1500
└─ ФГ3 (Органика) $1500

Milestone "Первые $5000" → выплата Иванову за достижение группой $5000
```

### ✅ Новое правило: За раннюю ФГ при достижении суммы
**Тип:** `earlyFgWithThreshold`

**Логика:**
1. Определяется самая ранняя ФГ с менеджером в группе агента
2. Комиссия начисляется за предоплаты **только этой ФГ**
3. **Только если** общая сумма группы достигла порога

**Параметры:**
- Процент (%) за раннюю ФГ
- Минимальная сумма группы ($)
- Применять только в период отчёта (опция)

**Пример:**
```
Правило: 10% за раннюю ФГ при достижении $3000

Группа "Omar Ali":
├─ ФГ1 (Recruiter: Иванов, дата: 10.10.2024) → самая ранняя
├─ ФГ2 (Recruiter: Иванов, дата: 15.11.2024)
└─ ФГ3 (Recruiter: Иванов, дата: 01.12.2024)

Предоплаты:
- ФГ1: $1000
- ФГ2: $1200  
- ФГ3: $800
ИТОГО: $3000 (порог достигнут!)

Комиссия: 10% от $1000 (только ФГ1) = $100
```

## Типы правил комиссий

### 1. Процент
Стандартная комиссия от предоплаты
```
Пример: 5% от всех предоплат
```

### 2. Фикс
Фиксированная сумма за каждую предоплату
```
Пример: $50 за каждую предоплату
```

### 3. Процент с ограничением
Процент, но не более максимальной суммы
```
Пример: 10% но не более $500
```

### 4. Только за первую предоплату агента
Комиссия начисляется только за самую первую предоплату каждого агента
```
Пример: 15% за первую предоплату
+ Опция "Только в периоде" → только если первая предоплата в отчётном периоде
```

### 5. За раннюю ФГ при достижении суммы (НОВОЕ)
Комиссия за самую раннюю ФГ с менеджером при достижении порога группой
```
Пример: 10% за раннюю ФГ, порог $3000
→ Когда группа достигнет $3000, начисляется 10% от предоплат только ранней ФГ
```

## Технологии

- **Frontend:** Vanilla JavaScript (ES6+), HTML5, CSS3
- **Хранение:** IndexedDB (session-only)
- **CSV парсинг:** PapaParse 5.4.1

## Структура проекта

```
commission-system/
├── index.html
├── css/styles.css
├── js/
│   ├── app.js         # Фильтрация ФГ, группировка агентов
│   ├── db.js          # IndexedDB
│   ├── managers.js    # Менеджеры
│   ├── rules.js       # 5 типов правил
│   ├── milestones.js  # Milestones по группам
│   ├── fg.js          # Группировка + сортировка
│   └── report.js      # Логика групп + milestones
```

## Функционал

### 1. Загрузка данных
- Импорт CSV с ФГ
- Импорт CSV с предоплатами
- **Автофильтрация:** только ФГ с предоплатами
- Группировка по агентам (первые 2 слова)
- Объединение похожих имён (≤2 символа)

### 2. Распределение источников
- Recruiter → менеджер назначается
- Account → менеджер назначается
- Проект/Органика/Акция → БЕЗ менеджера

### 3. Менеджеры
- CRUD Recruiters
- CRUD Account Managers
- Персональные правила

### 4. Правила комиссий
5 типов (см. выше) + опции:
- Временные рамки
- Только в период отчёта
- Множественный выбор менеджеров

### 5. Milestones
- По группам агентов
- Сумма = вся группа (включая Проект/Органика)
- Выплата рекрутеру, если агент приведён

### 6. ФГ
- Группировка по агентам
- Сворачивание/разворачивание
- Сортировка (Агент, Сумма, Комиссия)
- Подсчёт итогов по группе

### 7. Отчёт
- Группировка по менеджерам
- Сворачивание списка ФГ
- Только ФГ с менеджером в расчётах
- Учёт всех правил + milestones

## Логика работы

### Определение менеджера группы
1. Берём все ФГ агента
2. Если хоть одна имеет Recruiter/Account → он становится менеджером группы
3. Все остальные ФГ группы (Проект/Органика/Акция) НЕ учитываются в комиссиях

### Расчёт комиссий
1. Проверяем: ФГ имеет менеджера? → ДА
2. Проверяем: менеджер ФГ = менеджер группы? → ДА
3. Применяем правила для этой ФГ
4. ФГ без менеджера или с другим источником → игнорируем

### Расчёт Milestones
1. Суммируем **все** предоплаты группы агента
2. Проверяем: достигнут порог milestone?
3. Если ДА и агент приведён рекрутером → выплата рекрутеру
4. Сумма рассчитывается по всей группе (включая ФГ без менеджера)

### Правило "earlyFgWithThreshold"
1. Находим самую раннюю ФГ с менеджером (по дате "Начало работы")
2. Считаем общую сумму группы агента
3. Если сумма ≥ порога → начисляем % от предоплат только ранней ФГ
4. Опция "Период отчёта" → только если предоплаты ранней ФГ в периоде

## Деплой

### Netlify Drag & Drop
1. Распаковать `commission-system.tar.gz`
2. https://app.netlify.com/drop
3. Перетащить папку
4. Готово!

### Netlify CLI
```bash
npm install -g netlify-cli
netlify login
cd commission-system
netlify deploy --prod --dir=.
```

## Локальный запуск

```bash
python3 -m http.server 8000
# или
npx http-server -p 8000
```

## Форматы CSV

### ФГ
- `ФГ` — название (для извлечения агента)
- `Номер ФГ` — уникальный ID
- `Начало работы` — дата (для определения ранней ФГ)
- `Реф` — реферальная ссылка

### Предоплаты
- `Номер фин. группы` — связь с ФГ
- `Пополнения $` — сумма
- `Период` — дата (для первой предоплаты)

## Примеры сценариев

### Сценарий 1: Бонус за привлечение
```
Правило: Только за первую предоплату агента
Процент: 20%
Период: НЕ отмечено

→ Рекрутер получает 20% от первой предоплаты каждого агента
```

### Сценарий 2: Бонус за крупных клиентов
```
Правило: За раннюю ФГ при достижении суммы
Процент: 5%
Порог: $5000
Период: Отмечено (01.12.2024 - 31.12.2024)

→ Если группа агента достигла $5000 в декабре,
   рекрутер получает 5% от предоплат самой ранней ФГ
```

### Сценарий 3: Milestone за развитие
```
Milestone: "Топ агент $10000"
Группа: Только Recruiters
Выплата: 10%

→ Когда группа агента достигнет $10000 (все ФГ),
   рекрутер получает 10% от $10000 = $1000
```

## Производительность

- Загрузка: <1 сек
- Фильтрация ФГ: <50ms
- Расчёт отчёта: <100ms
- Размер: ~60KB

## Лицензия

MIT
