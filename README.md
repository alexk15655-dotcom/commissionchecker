# Система расчета комиссий

Чистый Vanilla JS MVP без фреймворков для расчета и управления комиссиями менеджеров.

## Новые возможности

- ✅ **Группировка по агентам**: Автоматическое извлечение имени агента из названия ФГ
- ✅ **Объединение похожих имён**: Агенты с отличием в 1-2 символа группируются вместе  
- ✅ **Назначение менеджера всем ФГ агента**: Один менеджер на всех агентов
- ✅ **Поддержка изменения источника**: Агент может перейти из "Проект" в "Recruiter"
- ✅ **Вывод рефа**: Отображение реферальной ссылки в таблице ФГ
- ✅ **Группировка по ФГ в отчёте**: Развёрнутый отчёт с детализацией по каждой ФГ

## Технологии

- **Frontend:** Vanilla JavaScript (ES6+), HTML5, CSS3
- **CSS:** Variables для light/dark тем
- **Хранение:** IndexedDB (session-only, данные удаляются при закрытии браузера)
- **CSV парсинг:** PapaParse 5.4.1 (CDN)

## Структура проекта

```
commission-system/
├── index.html              # Главная страница
├── css/
│   └── styles.css          # Стили с CSS Variables
├── js/
│   ├── app.js              # Главная логика приложения
│   ├── db.js               # IndexedDB управление
│   ├── managers.js         # Контроллер менеджеров
│   ├── rules.js            # Контроллер правил комиссий
│   ├── milestones.js       # Контроллер milestones
│   ├── fg.js               # Контроллер ФГ с агентами
│   └── report.js           # Контроллер отчетов и расчетов
```

## Функционал

### 1. Загрузка данных
- Импорт CSV с ФГ (финансовые группы)
- Импорт CSV с предоплатами
- Настройка пропорций распределения источников
- Автоматическое распределение менеджеров по источникам
- **Извлечение имени агента из названия ФГ**

### 2. Управление менеджерами
- Добавление/редактирование/удаление Recruiters
- Добавление/редактирование/удаление Account Managers
- Установка дат начала работы
- CRUD операции в реальном времени

### 3. Правила комиссий
- Именованные правила с описанием
- Типы комиссий: процент / фикс / процент с ограничением
- Привязка к конкретному менеджеру
- Временные рамки действия правила

### 4. Milestones
- Целевые суммы для бонусов
- Группировка: все / recruiters / accounts / выбор вручную
- Типы выплат: процент / фикс / процент с кэпом
- Автоматический расчет при достижении цели

### 5. Финансовые группы
- **Отображение агента для каждой ФГ**
- **Отображение рефа**
- Просмотр источника и менеджера
- Статистика по предоплатам
- Расчёт комиссий по ФГ

### 6. Отчеты
- Расчет комиссий в реальном времени
- Учет правил и milestones
- **Группировка по менеджерам с детализацией по ФГ**
- Фильтрация по датам
- Экспорт результатов (таблица)

## Деплой на Netlify

### Вариант 1: Drag & Drop (рекомендуется)

1. Открыть https://app.netlify.com/drop
2. Перетащить всю папку `commission-system/` в окно браузера
3. Готово! Netlify даст ссылку на сайт

### Вариант 2: Netlify CLI

```bash
# Установить Netlify CLI
npm install -g netlify-cli

# Войти в аккаунт
netlify login

# Деплой
cd commission-system
netlify deploy --prod --dir=.
```

### Вариант 3: GitHub

1. Создать репозиторий на GitHub
2. Запушить код:
```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin YOUR_REPO_URL
git push -u origin main
```

3. В Netlify:
   - New site from Git
   - Выбрать репозиторий
   - Build command: оставить пустым
   - Publish directory: `.` (корень)
   - Deploy site

## Локальное тестирование

Требуется локальный веб-сервер (из-за CORS и модулей):

```bash
# Python 3
python3 -m http.server 8000

# Node.js
npx http-server -p 8000

# PHP
php -S localhost:8000
```

Открыть: http://localhost:8000

## Форматы CSV

### Файл с ФГ
Обязательные колонки:
- `ФГ` — название финансовой группы (используется для извлечения имени агента)
- `Номер ФГ` — уникальный номер
- `Реф` — реферальная ссылка (опционально)

### Файл с предоплатами
Обязательные колонки:
- `Номер фин. группы` — связь с ФГ
- `Пополнения $` — сумма предоплаты
- `Период` — период (опционально)

## Логика группировки агентов

1. Из названия ФГ извлекаются **первые два слова**
2. Агенты сравниваются по **расстоянию Левенштейна**
3. Если отличие ≤ 2 символа → агенты объединяются
4. Менеджер назначается **всем ФГ агента**
5. Для "Акция" и "Органика" каждая ФГ может иметь своего менеджера

## Особенности

- **Session-only данные:** IndexedDB очищается при закрытии браузера
- **Нет бэкенда:** Все расчеты происходят на клиенте
- **Быстрая загрузка:** Нет зависимостей кроме PapaParse (CDN)
- **Responsive:** Адаптивный дизайн для мобильных
- **Темы:** Light/Dark переключение с сохранением в localStorage
- **Умная группировка агентов:** Автоматическое объединение похожих имён

## Браузерная совместимость

- Chrome/Edge: ✅
- Firefox: ✅
- Safari: ✅
- Mobile browsers: ✅

Требуется поддержка:
- ES6+ (стрелочные функции, async/await, классы)
- IndexedDB
- CSS Variables
- FileReader API

## Производительность

- Загрузка: < 1 секунда
- Обработка 1000 записей: < 100ms
- Расчет отчета: < 50ms
- Размер: ~50KB (без PapaParse)

## Безопасность

- Все данные хранятся локально
- Нет отправки на сервер
- Session-only IndexedDB
- XSS защита через textContent/innerHTML санитизацию

## Лицензия

MIT
