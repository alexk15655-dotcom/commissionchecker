<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система расчёта комиссий v6.0</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Система расчёта комиссий</h1>
            <p>Версия 6.0</p>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="fg">Загрузка данных</button>
            <button class="tab-btn" data-tab="managers">Менеджеры</button>
            <button class="tab-btn" data-tab="rules">Правила комиссий</button>
            <button class="tab-btn" data-tab="milestones">Milestones</button>
            <button class="tab-btn" data-tab="report">Отчёт</button>
            <button class="tab-btn" data-tab="settings">Настройки</button>
        </nav>

        <!-- Секция: Загрузка данных -->
        <section id="fg-section" class="tab-content active">
            <h2>Загрузка данных</h2>

            <!-- ПЕРИОД ОТЧЁТА -->
            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 3px solid var(--accent-primary);">
                <h3 style="margin-bottom: 1rem; color: var(--accent-primary);">Период отчёта</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                    <div class="form-group">
                        <label>Дата начала</label>
                        <input type="date" id="global-start-date" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label>Дата окончания</label>
                        <input type="date" id="global-end-date" style="width: 100%;">
                    </div>
                </div>
                <small style="color: var(--text-tertiary); display: block;">
                    Этот период будет автоматически применён при расчёте отчёта. Изменить можно в любой момент.
                </small>
            </div>

            <!-- Загрузка ФГ -->
            <div class="card">
                <h3>Финансовые группы (ФГ)</h3>
                <input type="file" id="fg-upload" accept=".csv">
                <div id="fg-stats" class="stats" style="display: none;">
                    <p>Загружено ФГ: <span id="fg-count">0</span></p>
                </div>
            </div>

            <!-- Загрузка предоплат -->
            <div class="card">
                <h3>Предоплаты</h3>
                <input type="file" id="prepayments-upload" accept=".csv">
                <div id="prepayments-stats" class="stats" style="display: none;">
                    <p>Загружено записей: <span id="prepayments-count">0</span></p>
                </div>
            </div>

            <!-- Распределение источников -->
            <div class="card">
                <h3>Распределение источников</h3>
                <div class="form-group">
                    <label>Recruiter (%)</label>
                    <input type="number" id="recruiter-percent" value="40" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Account (%)</label>
                    <input type="number" id="account-percent" value="40" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Project (%)</label>
                    <input type="number" id="project-percent" value="20" min="0" max="100">
                </div>
                <button class="btn btn-primary" id="distribute-btn">Распределить источники</button>
            </div>

            <!-- Таблица ФГ -->
            <div class="card">
                <h3>Список ФГ</h3>
                <div style="overflow-x: auto;">
                    <table id="fg-table">
                        <thead>
                            <tr>
                                <th>ФГ</th>
                                <th>Номер ФГ</th>
                                <th>Агент</th>
                                <th>Дата создания ФГ</th>
                                <th>Первая предоплата</th>
                                <th>Реф</th>
                                <th>Источник</th>
                                <th>Менеджер</th>
                                <th>Сумма предоплат</th>
                                <th>Выплачено комиссии</th>
                            </tr>
                        </thead>
                        <tbody id="fg-tbody">
                            <tr>
                                <td colspan="10" style="text-align: center; color: var(--text-tertiary); padding: 2rem;">
                                    Загрузите данные по ФГ
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Секция: Менеджеры -->
        <section id="managers-section" class="tab-content">
            <h2>Менеджеры</h2>

            <div class="card">
                <h3>Recruiters</h3>
                <button class="btn btn-primary" id="add-recruiter-btn">Добавить рекрутера</button>
                <div id="recruiters-list" style="margin-top: 1rem;">
                    <p style="color: var(--text-tertiary); text-align: center; padding: 2rem;">Рекрутеры не добавлены</p>
                </div>
            </div>

            <div class="card">
                <h3>Account Managers</h3>
                <button class="btn btn-primary" id="add-account-btn">Добавить аккаунт-менеджера</button>
                <div id="accounts-list" style="margin-top: 1rem;">
                    <p style="color: var(--text-tertiary); text-align: center; padding: 2rem;">Аккаунт-менеджеры не добавлены</p>
                </div>
            </div>
        </section>

        <!-- Секция: Правила комиссий -->
        <section id="rules-section" class="tab-content">
            <h2>Правила комиссий</h2>
            <button class="btn btn-primary" id="add-rule-btn">Добавить правило</button>
            <div id="rules-list" style="margin-top: 1rem;">
                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem;">Правила не добавлены</p>
            </div>
        </section>

        <!-- Секция: Milestones -->
        <section id="milestones-section" class="tab-content">
            <h2>Milestone-бонусы</h2>
            <button class="btn btn-primary" id="add-milestone-btn">Добавить milestone</button>
            <div id="milestones-list" style="margin-top: 1rem;">
                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem;">Milestones не добавлены</p>
            </div>
        </section>

        <!-- Секция: Отчёт -->
        <section id="report-section" class="tab-content">
            <h2>Отчёт по комиссиям</h2>

            <div class="card">
                <h3>Параметры отчёта</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Дата начала</label>
                        <input type="date" id="report-start-date">
                    </div>
                    <div class="form-group">
                        <label>Дата окончания</label>
                        <input type="date" id="report-end-date">
                    </div>
                </div>
                <button class="btn btn-primary" id="calculate-btn">Рассчитать комиссии</button>
            </div>

            <div class="card">
                <h3>Статистика</h3>
                <div class="stats">
                    <div class="stat-item">
                        <span>Общая сумма предоплат:</span>
                        <strong id="total-prepayments">$0.00</strong>
                    </div>
                    <div class="stat-item">
                        <span>Комиссии к выплате:</span>
                        <strong id="total-commissions">$0.00</strong>
                    </div>
                    <div class="stat-item">
                        <span>Количество менеджеров:</span>
                        <strong id="total-managers">0</strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Детальный отчёт</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th colspan="4">Менеджер / Агент / ФГ</th>
                                <th>Предоплаты</th>
                                <th>Комиссия</th>
                                <th>Milestone</th>
                                <th>Итого</th>
                            </tr>
                        </thead>
                        <tbody id="report-tbody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-tertiary); padding: 2rem;">
                                    Загрузите данные для расчета комиссий
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Секция: Настройки -->
        <section id="settings-section" class="tab-content">
            <h2>Настройки</h2>

            <div class="card">
                <h3>Комиссия по умолчанию</h3>
                <div class="form-group">
                    <label>Процент (%)</label>
                    <input type="number" id="default-commission" value="5" min="0" max="100" step="0.1">
                </div>
                <button class="btn btn-primary" id="save-commission-btn">Сохранить</button>
            </div>

            <div class="card">
                <h3>Экспорт/Импорт</h3>
                <button class="btn btn-primary" id="export-btn">Экспорт всех данных</button>
                <button class="btn btn-secondary" id="import-btn">Импорт данных</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>

            <div class="card">
                <h3>Очистка данных</h3>
                <button class="btn btn-danger" id="clear-all-btn">Очистить все данные</button>
            </div>
        </section>
    </div>

    <!-- Модальное окно -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Библиотеки -->
    <script src="libs/localforage.min.js"></script>
    <script src="libs/papaparse.min.js"></script>

    <!-- Скрипты приложения -->
    <script src="js/db.js"></script>
    <script src="js/managers.js"></script>
    <script src="js/rules.js"></script>
    <script src="js/milestones.js"></script>
    <script src="js/fg.js"></script>
    <script src="js/report.js"></script>
    <script src="js/app.js"></script>

    <script>
    // Синхронизация глобального периода с отчётом
    document.addEventListener('DOMContentLoaded', () => {
        const globalStart = document.getElementById('global-start-date');
        const globalEnd = document.getElementById('global-end-date');
        const reportStart = document.getElementById('report-start-date');
        const reportEnd = document.getElementById('report-end-date');
        
        // Синхронизация при изменении глобального периода
        if (globalStart && reportStart) {
            globalStart.addEventListener('change', () => {
                reportStart.value = globalStart.value;
            });
        }
        
        if (globalEnd && reportEnd) {
            globalEnd.addEventListener('change', () => {
                reportEnd.value = globalEnd.value;
            });
        }
        
        // Инициализация значениями по умолчанию
        const today = new Date().toISOString().split('T')[0];
        const monthAgo = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
        
        if (globalStart && !globalStart.value) globalStart.value = monthAgo;
        if (globalEnd && !globalEnd.value) globalEnd.value = today;
        if (reportStart && !reportStart.value) reportStart.value = monthAgo;
        if (reportEnd && !reportEnd.value) reportEnd.value = today;
    });
    </script>
</body>
</html>
